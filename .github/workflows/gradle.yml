name: Java CI with Gradle

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}  # Root 비밀번호
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}  # 데이터베이스 이름
          MYSQL_USER: ${{ secrets.DB_USER }}  # 사용자 이름
          MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD }}  # 사용자 비밀번호
        options: --health-cmd="mysqladmin ping --host 127.0.0.1 --password=${{ secrets.DB_PASSWORD }} --user=${{ secrets.DB_USER }} --silent" --health-interval=5s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Check commit message and PR title for "[#" trigger
        id: check_trigger
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MESSAGE"
          
          PR_TITLE=""
          if [[ -f "$GITHUB_EVENT_PATH" ]]; then
            PR_TITLE=$(jq --raw-output .pull_request.title $GITHUB_EVENT_PATH)
            echo "PR Title: $PR_TITLE"
          fi
          
          # 커밋 메시지 또는 PR 제목이 '[#'로 시작하는지 확인
          if [[ "$COMMIT_MESSAGE" == \[#* || "$PR_TITLE" == \[#* ]]; then
            echo "CI triggered because commit message or PR title starts with '[#'"
          else
            echo "Skipping CI because commit message and PR title do not start with '[#'"
            exit 0
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Give execute permission to gradlew
        run: chmod +x ./gradlew  # 실행 권한 부여

      # 환경 변수 설정
      - name: Set environment variables for database
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV  # MySQL 서비스의 기본 호스트는 localhost
          echo "DB_PORT=3306" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "MYSQL_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> $GITHUB_ENV

      # MySQL 준비 완료 대기
      - name: Wait for MySQL to be ready
        run: |
          until mysql -h localhost -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e 'SELECT 1'; do
          echo "Waiting for MySQL to be ready..."
          sleep 5
          done    

      - name: Create application.properties with relative path
        run: |
          echo "spring.datasource.url=jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}" > src/main/resources/application.properties
          echo "spring.datasource.username=${DB_USER}" >> src/main/resources/application.properties
          echo "spring.datasource.password=${DB_PASSWORD}" >> src/main/resources/application.properties
          echo "spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver" >> src/main/resources/application.properties
          echo "spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect" >> src/main/resources/application.properties

      - name: Check application.properties content
        run: cat src/main/resources/application.properties

      - name: Set permissions for application.properties
        run: |
          chmod 644 src/main/resources/application.properties
          ls -l src/main/resources/

      - name: Check if application.properties exists
        run: |
          ls -l src/main/resources/
          cat src/main/resources/application.properties || echo "application.properties not found"

      - name: Build with Gradle
        run: ./gradlew build  # Gradle을 사용하여 빌드 실행

      - name: Run tests with Gradle
        run: ./gradlew test  # Gradle을 사용하여 테스트 실행

      - name: Generate Gradle dependency report
        run: ./gradlew dependencies --configuration compileClasspath > dependencies.txt

      - name: Upload dependency graph
        uses: actions/upload-artifact@v3
        with:
          name: gradle-dependency-report
          path: dependencies.txt
